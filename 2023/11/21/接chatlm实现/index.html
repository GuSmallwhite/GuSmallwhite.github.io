<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="接chatlm实现, 说的">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>接chatlm实现 | 说的</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.1.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>




<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">说的</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">说的</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">接chatlm实现</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/langchain/">
                                <span class="chip bg-color">langchain</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AE%9E%E9%AA%8C%E5%AE%A4/" class="post-category">
                                实验室
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-11-21
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>按学长要求，我来实现接chatlm</p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>首先，<strong>memory</strong>包是不用动的，这部分接口学长已经完成</p>
<p><strong>tool</strong>包也是不要动的，这部分是就是些工具和调用oj的接口，不需要修改和新增</p>
<p><strong>Util</strong>包也不用动，这部分就是发送http请求到model和oj的函数</p>
<p><strong>bo</strong>包也不用动，这部分就是两个bo，没啥好说的</p>
<p><strong>所以需要修改&#x2F;新增的</strong>：</p>
<ul>
<li><strong>executor</strong>包：defaultexecutor里面，map放的是starcoder，我这边接llama7b，需要新增一个llama7bexecutor</li>
<li><strong>llm</strong>包：一样的，原本是starcoderllm类里面call函数调用starcoderllm，我这边需要新增一个llama7bllm，call函数调用llama7b</li>
<li><strong>prompt</strong>包：同样，本来是parse Starcoder的token，这边要生成llama7b的token</li>
</ul>
<p>基本上就是新增这三个类</p>
<p>然后分析，需要先写哪个再写哪个</p>
<p>这里面最关键的，也是最难的其实是这几个地方</p>
<ol>
<li>根据模型生成的消息，分析获得codeGenerate和msgContent，这部分和starcoder不一样（废话，这部分是在模型对应llm的<strong>call函数</strong>里</li>
<li>生成prompt，这里有点疑问，就是为什么starcoder要给message加入那些token?这部分在<strong>prompt</strong>包里</li>
<li>executor没什么问题，这部分照猫画虎就行了</li>
</ol>
<p>综上所述，先写executor，要调用的<strong>parsePrompt</strong>和<strong>call</strong>先留着空接口</p>
<h2 id="Llama7bExecutor"><a href="#Llama7bExecutor" class="headerlink" title="Llama7bExecutor"></a>Llama7bExecutor</h2><p>绝大部分和DefaultExecutor差不多</p>
<p>就是改了一下map里put是啥玩意</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>executor</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>bo<span class="token punctuation">.</span></span><span class="token class-name">QuestionBO</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>bo<span class="token punctuation">.</span></span><span class="token class-name">TestcaseBO</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>llm<span class="token punctuation">.</span></span><span class="token class-name">BaseLlm</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>llm<span class="token punctuation">.</span></span><span class="token class-name">Llama7bLlm</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">BaseChatMessageHistory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">BaseMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">HumanMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">SystemMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>prompt<span class="token punctuation">.</span></span><span class="token class-name">BasePromptTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>prompt<span class="token punctuation">.</span></span><span class="token class-name">Llama7bPromptTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>prompt<span class="token punctuation">.</span></span><span class="token class-name">StarCoderPromptTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>tool<span class="token punctuation">.</span></span><span class="token class-name">OjRunTool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>njuse<span class="token punctuation">.</span>cpp<span class="token punctuation">.</span>tool<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">OjEnum</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">FluxSink</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Llama7bExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">BaseExecutor</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BaseLlm</span><span class="token punctuation">></span></span> <span class="token constant">MODEL_POOL</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">BaseLlm</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>
        <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Llama7b"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Llama7bLlm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BasePromptTemplate</span><span class="token punctuation">></span></span> <span class="token constant">PROMPT_TEMPLATE_MAP</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">BasePromptTemplate</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>
        <span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Llama7b"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Llama7bPromptTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> <span class="token constant">MAX_ROUND</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BaseChatMessageHistory</span> memory<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BaseChatMessageHistory</span><span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">QuestionBO</span> questionBO<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">QuestionBO</span><span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"question"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestcaseBO</span><span class="token punctuation">></span></span> testcaseBOS<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestcaseBO</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"testcases"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> modelName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"modelName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FluxSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BaseMessage</span><span class="token punctuation">></span></span> emit <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FluxSink</span><span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"emit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">HumanMessage</span> humanMessage<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HumanMessage</span><span class="token punctuation">(</span><span class="token string">"Description:"</span><span class="token operator">+</span>questionBO<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memory<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>humanMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>humanMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">BaseLlm</span> model<span class="token operator">=</span><span class="token constant">MODEL_POOL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>modelName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BasePromptTemplate</span> promptTemplate<span class="token operator">=</span><span class="token constant">PROMPT_TEMPLATE_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>modelName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token constant">MAX_ROUND</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> prompt<span class="token operator">=</span>promptTemplate<span class="token punctuation">.</span><span class="token function">parsePrompt</span><span class="token punctuation">(</span>memory<span class="token punctuation">.</span><span class="token function">loadMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> llmResponse<span class="token operator">=</span>model<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">OjRunTool</span> ojRunTool<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">OjRunTool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> input<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            input<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"question"</span><span class="token punctuation">,</span>questionBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
            input<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"testcases"</span><span class="token punctuation">,</span>testcaseBOS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            input<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span>llmResponse<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BaseMessage</span> message<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BaseMessage</span><span class="token punctuation">)</span> llmResponse<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            emit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            memory<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> toolOutput<span class="token operator">=</span>ojRunTool<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">OjEnum</span> ojRes<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">OjEnum</span><span class="token punctuation">)</span> toolOutput<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"OjRes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>ojRes<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">OjEnum</span><span class="token punctuation">.</span><span class="token constant">PASS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> extendedParam<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                extendedParam<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"statusCode"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SystemMessage</span> systemMessage<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SystemMessage</span><span class="token punctuation">(</span>ojRes<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> extendedParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
                emit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>systemMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                emit<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name">HumanMessage</span> ojMessage<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HumanMessage</span><span class="token punctuation">(</span>ojRes<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                emit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>ojMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                memory<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>ojMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> extendedParam<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        extendedParam<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"statusCode"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SystemMessage</span> systemMessage<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SystemMessage</span><span class="token punctuation">(</span><span class="token string">"The model cannot pass the oj"</span><span class="token punctuation">,</span>extendedParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>systemMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        emit<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Llama7bLlm"><a href="#Llama7bLlm" class="headerlink" title="Llama7bLlm"></a>Llama7bLlm</h2><p>这部分要修改的东西主要有：</p>
<ul>
<li>调用哪个接口</li>
<li>将prompt转成json</li>
<li>codeGenerator这个是生成的纯代码，就是要放到oj里运行的</li>
<li>msgcontent，这部分是要放到message里，然后存到memory里</li>
<li>getMessagecontent方法，这部分因为prompt的不同，也不同</li>
</ul>
<h3 id="静态变量"><a href="#静态变量" class="headerlink" title="静态变量"></a><strong>静态变量</strong></h3><p>这部分不用改</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger<span class="token operator">=</span><span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">StarCoderLlm</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">OkHttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="将String类型的promt放入json中"><a href="#将String类型的promt放入json中" class="headerlink" title="将String类型的promt放入json中"></a><strong>将String类型的promt放入json中</strong></h3><p><strong>这部分不一样</strong></p>
<p>starcoder的prompt是字符串，而llama7b的输入类型：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
    <span class="token string">"prompt"</span><span class="token operator">:</span> <span class="token string">"[&#123;\"role\": \"user\", \"content\": \"Description: Implement a c++ program to compute a+b. Requirement: Generate a complete c++ program from the previous description, encasing the code blocks in backquotes. The input contains only numbers separated by two Spaces. The output contains only the answers. Don't output any extra statements.\"&#125;]"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>也就是说我需要把</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Description</span><span class="token operator">:</span> <span class="token class-name">Implement</span> a c<span class="token operator">++</span> program <span class="token keyword">to</span> <span class="token namespace">compute</span> a<span class="token operator">+</span><span class="token class-name"><span class="token namespace">b<span class="token punctuation">.</span></span> Requirement</span><span class="token operator">:</span> <span class="token class-name">Generate</span> a complete c<span class="token operator">++</span> program from the previous description<span class="token punctuation">,</span> encasing the code blocks in <span class="token class-name"><span class="token namespace">backquotes<span class="token punctuation">.</span></span> The</span> input contains only numbers separated by two <span class="token class-name">Spaces<span class="token punctuation">.</span> The</span> output contains only the <span class="token class-name"><span class="token namespace">answers<span class="token punctuation">.</span></span> Don</span>'t output any extra statements<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这一段字符串</p>
<p>转变成</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
    <span class="token string">"prompt"</span><span class="token operator">:</span> <span class="token string">"[&#123;\"role\": \"user\", \"content\": \"Description: Implement a c++ program to compute a+b. Requirement: Generate a complete c++ program from the previous description, encasing the code blocks in backquotes. The input contains only numbers separated by two Spaces. The output contains only the answers. Don't output any extra statements.\"&#125;]"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>注意此处的坑</strong>，</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token string">"[&#123;\"role\": \"user\", \"content\": \"Description: Implement a c++ program to compute a+b. Requirement: Generate a complete c++ program from the previous description, encasing the code blocks in backquotes. The input contains only numbers separated by two Spaces. The output contains only the answers. Don't output any extra statements.\"&#125;]"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>这一段他妈是字符串！数组是在字符串里的！草拟吗</strong></p>
<p>gpt提供给我的方案:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">JSONArray</span> promptArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">JSONObject</span> promptObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promptObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promptObject<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
promptArray<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>promptObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">JSONObject</span> json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"prompt"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>promptArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先这么写吧</p>
<h3 id="codegenerate"><a href="#codegenerate" class="headerlink" title="codegenerate"></a>codegenerate</h3><p>这部分是要送给pj评测的代码，所以我得确定这里面必须是纯代码部分</p>
<p>比如</p>
<p>starcoder里面：</p>
<p>llmresponse是这个</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token string">"Description: Implement a c++ program to compute a+b. Requirement: Generate a complete c++ program from the previous description, encasing the code blocks in backquotes. The input contains only numbers separated by two Spaces. The output contains only the answers. Don't output any extra statements.\n&lt;|assistant|>\n```c++\n#include &lt;iostream>\nusing namespace std;\n \nint main() &#123;\n    int a, b;\n    cin >> a >> b;\n    cout &lt;&lt; a + b;\n    return 0;\n&#125;\n```&lt;|end|>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后我们提取出来的代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">codeGenerate<span class="token operator">=</span>llmResponse<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>promptLength<span class="token punctuation">)</span><span class="token comment">//先跳过用户输入的部分 </span>
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"```"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后llmResponse是</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">#include <span class="token generics"><span class="token punctuation">&lt;</span>iostream<span class="token punctuation">></span></span>
using namespace std<span class="token punctuation">;</span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>
    cin <span class="token operator">>></span> a <span class="token operator">>></span> b<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以同样的，我们也要提取出这样的代码</p>
<p>首先来看llama7b给我们的回复</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token string">" Here is a complete C++ program that computes the sum of two numbers, `a` and `b`, and outputs the result:\n```\n#include &lt;iostream>\n\nint main() &#123;\n    int a, b;\n    std::cout &lt;&lt; \"Enter two numbers: \";\n    std::cin >> a >> b;\n    int sum = a + b;\n    std::cout &lt;&lt; \"The sum is: \" &lt;&lt; sum &lt;&lt; std::endl;\n    return 0;\n&#125;\n```\nThis program uses the `std::cin` and `std::cout` streams to read input from the user and print output to the console. The `std::cin` stream is used to read the two numbers `a` and `b` from the user, and the `std::cout` stream is used to print the sum of `a` and `b` to the console. The `int sum = a + b;` line computes the sum of `a` and `b` and stores it in the `sum` variable. Finally, the `std::cout` stream is used to print the value of `sum` to the console."</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>首先看出来，llama7b并不会像starcoder一样把descirption也说一遍</p>
<p>而且&#96;&#96;&#96;之前也没有c++这种</p>
<p>那就很简单了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">codeGenerate<span class="token operator">=</span>llmResponse<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"```"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>就行了</p>
<h3 id="getmessagecontent"><a href="#getmessagecontent" class="headerlink" title="getmessagecontent"></a>getmessagecontent</h3><p>对于没有生成代码，也就是没有”&#96;&#96;&#96;”的回复，我们要使用getmessagecontent</p>
<p>以及，最后，我们也要使用getmessagecontent，把他作为aimessage返回</p>
<p>我们来看看starcoder</p>
<p>他的返回：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token string">"Description: Implement a c++ program to compute a+b. Requirement: Generate a complete c++ program from the previous description, encasing the code blocks in backquotes. The input contains only numbers separated by two Spaces. The output contains only the answers. Don't output any extra statements.\n&lt;|assistant|>\n```c++\n#include &lt;iostream>\nusing namespace std;\n \nint main() &#123;\n    int a, b;\n    cin >> a >> b;\n    cout &lt;&lt; a + b;\n    return 0;\n&#125;\n```&lt;|end|>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看到说，他是有&lt;|assistant|&gt;和&lt;|end|&gt;标志的</p>
<p>并且他首先会把你的description再说一遍</p>
<p>所以学长使用了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> msgContent<span class="token operator">=</span><span class="token function">getMessageContent</span><span class="token punctuation">(</span>llmResponse<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>promptLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>先把你输入的部分（也就是prompt，跳过了</p>
<p>然后再</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getMessageContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> tempStr <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token class-name">StarCoderPromptTemplate</span><span class="token punctuation">.</span><span class="token constant">ASSISTANT_TOKEN</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
            text<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token class-name">StarCoderPromptTemplate</span><span class="token punctuation">.</span><span class="token constant">END_TOKEN</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> tempStr<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>截取出两个token之间的值，那就是ai生成的东西了</p>
<p>那么到llama7b呢，我们来看看她的返回</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token string">" Here is a complete C++ program that computes the sum of two numbers:\n```\n#include &lt;iostream>\n\nint main() &#123;\n    int a, b;\n    std::cout &lt;&lt; \"Enter two numbers: \";\n    std::cin >> a >> b;\n    std::cout &lt;&lt; \"The sum of \" &lt;&lt; a &lt;&lt; \" and \" &lt;&lt; b &lt;&lt; \" is \" &lt;&lt; a + b &lt;&lt; std::endl;\n    return 0;\n&#125;\n```\nThis program uses the `std::cin` and `std::cout` streams to read and print input and output, respectively. The `std::endl` statement is used to insert a newline character at the end of the output.\n\nTo use this program, simply compile and run it with the following command:\n```\ng++ sum.cpp -o sum\n./sum\n```\nThis will prompt the user to enter two numbers, and then print the sum of those numbers. For example, if the user enters the numbers 3 and 4, the program will print the sum of 3 and 4, which is 7."</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>首先他不抄题目，然后他也没有什么token这种的，那如果他不生成代码</p>
<p>我把他整个的回复返回了不就行了</p>
<p>正确的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getMessageContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> text<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后调用也不用先sub promptlength了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> msgContent<span class="token operator">=</span><span class="token function">getMessageContent</span><span class="token punctuation">(</span>llmResponse<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>即可</p>
<h2 id="Llama7bPromptTemplate"><a href="#Llama7bPromptTemplate" class="headerlink" title="Llama7bPromptTemplate"></a>Llama7bPromptTemplate</h2><p>有点问题，先放着</p>
<p>我现在的思路是，既然llama7b没有固定的token格式</p>
<p>那我就这么定义了：</p>
<pre class="line-numbers language-none"><code class="language-none">public static final String SYS_TOKEN&#x3D;&quot;Here is System_Message&quot;;
public static final String SYS_END_TOKEN&#x3D;&quot;System_Message_End&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>先这么说吧，累了，睡觉了</p>
<p>那么我的想法也很简单，我的prompt就是</p>
<pre class="line-numbers language-none"><code class="language-none">Description: Implement a c++ program to compute a+b. Requirement: Generate a complete c++ program from the previous description, encasing the code blocks in backquotes. The input contains only numbers separated by two Spaces. The output contains only the answers. Don&#39;t output any extra statements.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后我只要在前后加入”Here is System_Message”;”System_Message_End”;等等即可</p>
<p>因为反正我这里的prompt，在真正的promt json中，只是content键对应的值而已</p>
<p>所以这样是可行的</p>
<h3 id="token定义"><a href="#token定义" class="headerlink" title="token定义"></a>token定义</h3><p><strong>我们来看看starcoder的token是怎么定义的</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYS_TOKEN</span><span class="token operator">=</span><span class="token string">"&lt;|system|>"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_TOKEN</span><span class="token operator">=</span><span class="token string">"&lt;|user|>"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ASSISTANT_TOKEN</span><span class="token operator">=</span><span class="token string">"&lt;|assistant|>"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">END_TOKEN</span><span class="token operator">=</span><span class="token string">"&lt;|end|>"</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYS_MSG</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这部分是参考模型的返回得出的，但是我们的llama7b并没有这样的返回，所以我们可以自定义</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYS_BEGIN_TOKEN</span><span class="token operator">=</span><span class="token string">"Here is SystemMessage"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYS_END_TOKEN</span><span class="token operator">=</span><span class="token string">"SystemMessage End"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_BEGIN_TOKEN</span><span class="token operator">=</span><span class="token string">"Here is UserMessage"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">USER_END_TOKEN</span><span class="token operator">=</span><span class="token string">"UserMessage End"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ASSISTANT_BEGIN_TOKEN</span><span class="token operator">=</span><span class="token string">"Here is AssistantMessage"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ASSISTANT_END_TOKEN</span><span class="token operator">=</span><span class="token string">"UserMessage End"</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SYS_MSG</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>就这么看看吧，不知道能不能行</p>
<h3 id="parse方法"><a href="#parse方法" class="headerlink" title="parse方法"></a>parse方法</h3><p>照猫画虎</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">    public String parsePrompt(List&lt;BaseMessage&gt; messages) &#123;
        StringBuffer promptBuffer&#x3D;new StringBuffer();
        if(StringUtils.isNotBlank(SYS_MSG))&#123;
            promptBuffer.append(SYS_BEGIN_TOKEN+&quot;\n&quot; + SYS_MSG + SYS_END_TOKEN + &quot;\n&quot;);
        &#125;
        if(messages.isEmpty())&#123;
            throw new RuntimeException(&quot;Message List Cannot be empty&quot;);
        &#125;
        for(BaseMessage message:messages)&#123;
            if(message.type().equals(&quot;ai&quot;))&#123;
                promptBuffer.append(ASSISTANT_BEGIN_TOKEN+&quot;\n&quot; + message.getContent() + ASSISTANT_END_TOKEN + &quot;\n&quot;);
            &#125;
            else if(message.type().equals(&quot;human&quot;))&#123;
                promptBuffer.append(USER_BEGIN_TOKEN + &quot;\n&quot; + message.getContent() + USER_END_TOKEN + &quot;\n&quot;);
            &#125;
        &#125;
        promptBuffer.append(ASSISTANT_BEGIN_TOKEN);
        return promptBuffer.toString();
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>验证：</p>
<p>通过</p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/langchain/">
                                    <span class="chip bg-color">langchain</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/11/23/%E8%87%AA%E5%AD%A6rpc%E4%B9%8B%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="自学rpc之传输协议">
                        
                        <span class="card-title">自学rpc之传输协议</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-11-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/rpc%E9%A1%B9%E7%9B%AE/" class="post-category">
                                    rpc项目
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/rpc/">
                        <span class="chip bg-color">rpc</span>
                    </a>
                    
                    <a href="/tags/netty/">
                        <span class="chip bg-color">netty</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/11/19/langchain%E4%B9%8Bmodel%E5%B1%82%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="langchain之model层代码阅读">
                        
                        <span class="card-title">langchain之model层代码阅读</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-11-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AE%9E%E9%AA%8C%E5%AE%A4/" class="post-category">
                                    实验室
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/langchain/">
                        <span class="chip bg-color">langchain</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">G</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/GuSmallwhite" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>















    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</body>

</html>
