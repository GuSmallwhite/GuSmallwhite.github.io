<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="自学和再看rpc之通过注解注册消费, 说的">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>自学和再看rpc之通过注解注册消费 | 说的</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.1.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>




<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">说的</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">说的</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/23.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">自学和再看rpc之通过注解注册消费</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/rpc/">
                                <span class="chip bg-color">rpc</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                学习
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-11-28
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>傻逼guide一笔带过，我自己学得自己总结</p>
<p>这里讲的主要是通过注解注册&#x2F;消费服务</p>
<p>然后有的springboot的知识呢，学八股的时候再学习</p>
<h2 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h2><p>使用注解开发，而不是xml配置文件，好处是便捷性，操作性。<br>比如@Builder主要作用是用来生成对象，并能够进行链式赋值。</p>
<p>所以我们这里定义了两个注解</p>
<p>在annotation包里</p>
<p>@RpcService放在服务实现类上。<br>@RpcReference放在服务引用上。</p>
<p>服务端发送的数据类型是：RpcMessage&lt;RpcReponse<Object>&gt;。其中Object是为了包含服务的各种返回类型。<br>客户端发送的数据类型是：RpcMessage&lt;RpcRequest<Object>&gt;。</Object></Object></p>
<h3 id="RpcService"><a href="#RpcService" class="headerlink" title="@RpcService"></a>@RpcService</h3><p>注册服务</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * RPC service annotation, marked on the service implementation class
 *
 * @author shuang.kou
 * @createTime 2020年07月21日 13:11:00
 */</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RpcService</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * Service version, default value is empty string
     */</span>
    <span class="token class-name">String</span> <span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Service group, default value is empty string
     */</span>
    <span class="token class-name">String</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>@Documented</code>：该注解表示带有该类型的注解应该由javadoc和类似工具记录。换句话说，这个注解应该包含在注释元素的文档中。</p>
<p><code>@Retention(RetentionPolicy.RUNTIME)</code>：这表示该注解应在运行时保留。如果要使用反射在运行时访问注解，则这是必需的。</p>
<p><code>@Target(&#123;ElementType.TYPE&#125;)</code>：此注解仅允许在类声明上使用。</p>
<p><code>@Inherited</code>：这表示该注解类型可以从超类继承。</p>
<h3 id="RpcReference"><a href="#RpcReference" class="headerlink" title="@RpcReference"></a>@<strong>RpcReference</strong></h3><p>消费服务</p>
<ol>
<li>@RpcReference(version &#x3D; “version1”, group &#x3D; “test1”) private HelloService helloService; 该注解标记到成员变量上，然后对整个类使用@Component来注入到Spring中</li>
<li>实现BeanPostProcessor接口，实现里面的postProcessAfterInitialization方法，在Bean被初始化之后处理服务引用，生成代理对象</li>
<li>遍历Bean的成员变量，如果有@RpcReference则通过注解值获取RpcServiceConfig，然后传入RpcClient和RpcServiceConfig初始化RpcClientProxy。</li>
<li>通过代理类获取接口的代理对象，使用反射将Controller里的对象替换为我们的代理对象，再调用方法时，会调用到我们的invoke函数里，来实现发送request收到response的目的。</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RpcReference</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * Service version, default value is empty string
     */</span>
    <span class="token class-name">String</span> <span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Service group, default value is empty string
     */</span>
    <span class="token class-name">String</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="RpcScan"><a href="#RpcScan" class="headerlink" title="@RpcScan"></a>@RpcScan</h3><pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)
@Retention(RetentionPolicy.RUNTIME)
@Import(CustomScannerRegistrar.class)
@Documented
public @interface RpcScan &#123;

    String[] basePackage();&#x2F;&#x2F;指定要扫描的包路径，对应CustomScannerRegistrar里的BASE_PACKAGE_ATTRIBUTE_NAME

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过<code>@Import</code>注解导入了<code>CustomScannerRegistrar.class</code>，这可能是一个配置类，用于处理自定义的注解扫描逻辑。</p>
<h2 id="一些基本概念"><a href="#一些基本概念" class="headerlink" title="一些基本概念"></a>一些基本概念</h2><p>我他妈发现我一些基本概念都不懂啊</p>
<h3 id="注册Bean"><a href="#注册Bean" class="headerlink" title="注册Bean"></a>注册Bean</h3><p>“注册bean”通常是指将一个Java对象（被称为bean）注册到Spring容器中，以便由Spring进行管理。Spring容器是一个负责创建、配置和管理bean的容器。通过注册bean，我们告诉Spring框架如何实例化、配置和管理这些对象。</p>
<p><strong>注册了之后能干什么？</strong></p>
<blockquote>
<ol>
<li><strong>实例化和管理：</strong> Spring负责实例化bean，并在需要时管理其生命周期。它会根据配置或注解创建bean的实例，并在需要时销毁它们。</li>
<li><strong>依赖注入：</strong> Spring负责将bean之间的依赖关系注入到它们中。通过配置或注解，可以将其他bean引用注入到一个bean中，实现了松散耦合。</li>
<li><strong>AOP（面向切面编程）：</strong> Spring提供了强大的AOP支持，允许在应用程序中方便地使用切面来处理横切关注点，例如事务管理、日志记录等。</li>
<li><strong>声明性事务管理：</strong> 通过配置或注解，可以声明性地管理事务，而无需在代码中编写显式的事务管理代码。</li>
<li><strong>Spring Boot自动配置：</strong> 在Spring Boot应用程序中，注册的bean可以利用自动配置机制，使得开发者能够更轻松地构建和部署应用程序。</li>
<li><strong>组件扫描和自动装配：</strong> Spring容器可以扫描指定的包，自动发现标有特定注解的组件，并将它们自动装配到应用程序中。</li>
<li><strong>事件和监听器：</strong> Spring框架提供了事件和监听器机制，通过它们，bean可以发布和监听事件，实现模块之间的松散耦合通信。</li>
<li><strong>面向切面编程（AOP）：</strong> Spring允许通过AOP在应用程序中定义横切关注点，例如日志、事务管理等。</li>
</ol>
</blockquote>
<h3 id="Bean的实例化"><a href="#Bean的实例化" class="headerlink" title="Bean的实例化"></a>Bean的实例化</h3><p>简单来说就是创建一个对象</p>
<p>复杂来说就是</p>
<blockquote>
<ol>
<li><strong>Bean 的定义：</strong> 在 Spring 配置文件（如 XML 文件）、Java 类上的注解或者 Java 代码中定义 Bean。这个定义包含了 Bean 的类型、属性、依赖关系等信息。</li>
<li><strong>Spring 容器加载配置：</strong> Spring 容器读取配置文件或者扫描注解，解析配置信息，将 Bean 的定义信息加载到容器中。</li>
<li><strong>Bean 的实例化：</strong> 根据 Bean 的定义信息，Spring 容器使用适当的方式（通常是反射）实例化 Bean 对象。</li>
<li><strong>属性注入：</strong> 如果 Bean 的定义中包含属性信息，Spring 容器会将配置的属性值注入到 Bean 的对应属性中。</li>
<li><strong>初始化方法：</strong> 如果 Bean 的定义中有指定初始化方法，Spring 容器在实例化完成后调用该方法进行初始化。</li>
<li><strong>Bean 的使用：</strong> 完成初始化后，Bean 就可以被其他对象引用和使用了。</li>
<li><strong>销毁方法（可选）：</strong> 如果 Bean 的定义中有指定销毁方法，当容器关闭时，会调用该方法进行资源释放和清理。</li>
</ol>
</blockquote>
<h3 id="Spring启动时注解执行顺序"><a href="#Spring启动时注解执行顺序" class="headerlink" title="Spring启动时注解执行顺序"></a>Spring启动时注解执行顺序</h3><blockquote>
<ol>
<li><strong>加载配置类：</strong> 在启动时，Spring 会加载配置类，这包括通过 <code>@Configuration</code> 标记的配置类、通过 <code>@ComponentScan</code> 扫描的组件、通过 <code>@Import</code> 导入的其他配置类等。</li>
<li><strong>解析注解：</strong> 在加载配置类的过程中，Spring 会解析各种注解，包括 <code>@Bean</code>、<code>@Component</code>、<code>@Autowired</code> 等。在这个过程中，如果遇到了 <code>@Import</code> 注解，就会触发被导入配置类的解析和注册。</li>
<li><strong>初始化 ApplicationContext：</strong> 随后，Spring 会初始化 ApplicationContext（应用上下文）。在这一阶段，它会实例化 bean，完成依赖注入，执行生命周期方法，以及执行其他与 bean 相关的初始化工作。</li>
<li><strong>执行自定义逻辑：</strong> 在初始化 ApplicationContext 过程中，如果遇到实现了 <code>ImportBeanDefinitionRegistrar</code> 接口的类，Spring 会调用这些类的 <code>registerBeanDefinitions</code> 方法，执行自定义的逻辑，比如注册额外的 bean。</li>
</ol>
</blockquote>
<h3 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h3><p>在这里，元数据指的是有关代码元素（如类、方法、字段等）的信息。Java提供了<code>AnnotationMetadata</code>接口，该接口用于获取与注解相关的元数据信息，就是用来获取注解里面的内容的</p>
<h2 id="CustomScanner"><a href="#CustomScanner" class="headerlink" title="CustomScanner"></a>CustomScanner</h2><p>一个自定义扫描器，用于扫描指定包下的类，并根据给定的注解类型进行过滤。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomScanner</span> <span class="token keyword">extends</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">CustomScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span> annoType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">addIncludeFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>annoType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p><code>BeanDefinitionRegistry</code>是Spring框架中用于注册bean定义的接口。<code>Class&lt;? extends Annotation&gt;</code>是指定的注解类型。</p>
<p>在构造函数中，调用了<code>super(registry)</code>来调用父类的构造函数，并使用<code>super.addIncludeFilter(new AnnotationTypeFilter(annoType))</code>添加了一个包含过滤器，该过滤器根据给定的注解类型过滤扫描结果。也就是说保留含有特定注解的类</p>
<h3 id="scan方法"><a href="#scan方法" class="headerlink" title="scan方法"></a>scan方法</h3><p>它调用了父类的<code>scan</code>方法，实际上触发了扫描过程。传入的<code>basePackages</code>参数是要扫描的包路径。</p>
<p>所以这个类的主要作用就是，扫描带有特定注解的类，并且将他们注册为bean</p>
<h2 id="CustomScannerRegistrar"><a href="#CustomScannerRegistrar" class="headerlink" title="CustomScannerRegistrar"></a>CustomScannerRegistrar</h2><p>真正用来扫描包并进行注册的类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomScannerRegistrar</span> <span class="token keyword">implements</span> <span class="token class-name">ImportBeanDefinitionRegistrar</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLoaderAware</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_BEAN_BASE_PACKAGE</span> <span class="token operator">=</span> <span class="token string">"github.javaguide"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BASE_PACKAGE_ATTRIBUTE_NAME</span> <span class="token operator">=</span> <span class="token string">"basePackage"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> resourceLoader<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> annotationMetadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> beanDefinitionRegistry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//get the attributes and values ​​of RpcScan annotation</span>
        <span class="token class-name">AnnotationAttributes</span> rpcScanAnnotationAttributes <span class="token operator">=</span> <span class="token class-name">AnnotationAttributes</span><span class="token punctuation">.</span><span class="token function">fromMap</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">RpcScan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rpcScanBasePackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcScanAnnotationAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// get the value of the basePackage property</span>
            rpcScanBasePackages <span class="token operator">=</span> rpcScanAnnotationAttributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token constant">BASE_PACKAGE_ATTRIBUTE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcScanBasePackages<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            rpcScanBasePackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">StandardAnnotationMetadata</span><span class="token punctuation">)</span> annotationMetadata<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIntrospectedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// Scan the RpcService annotation</span>
        <span class="token class-name">CustomScanner</span> rpcServiceScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomScanner</span><span class="token punctuation">(</span>beanDefinitionRegistry<span class="token punctuation">,</span> <span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Scan the Component annotation</span>
        <span class="token class-name">CustomScanner</span> springBeanScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomScanner</span><span class="token punctuation">(</span>beanDefinitionRegistry<span class="token punctuation">,</span> <span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceLoader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            rpcServiceScanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            springBeanScanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">int</span> springBeanAmount <span class="token operator">=</span> springBeanScanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token constant">SPRING_BEAN_BASE_PACKAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"springBeanScanner扫描的数量 [&#123;&#125;]"</span><span class="token punctuation">,</span> springBeanAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rpcServiceCount <span class="token operator">=</span> rpcServiceScanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>rpcScanBasePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"rpcServiceScanner扫描的数量 [&#123;&#125;]"</span><span class="token punctuation">,</span> rpcServiceCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="字段和属性"><a href="#字段和属性" class="headerlink" title="字段和属性"></a>字段和属性</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_BEAN_BASE_PACKAGE</span> <span class="token operator">=</span> <span class="token string">"github.javaguide"</span><span class="token punctuation">;</span><span class="token comment">// Spring Bean 默认扫描的基础包路径。</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BASE_PACKAGE_ATTRIBUTE_NAME</span> <span class="token operator">=</span> <span class="token string">"basePackage"</span><span class="token punctuation">;</span><span class="token comment">//定义了 @RpcScan 注解中指定扫描包路径的属性名称。</span>
<span class="token keyword">private</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">;</span><span class="token comment">//加载资源的接口</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="registerBeanDefinitions"><a href="#registerBeanDefinitions" class="headerlink" title="registerBeanDefinitions"></a>registerBeanDefinitions</h3><p>在 Spring 启动过程中，当解析到配置类中的 <code>@Import(CustomScannerRegistrar.class)</code> 注解时，Spring 会触发 <code>CustomScannerRegistrar</code> 类的加载和初始化。在初始化过程中，会调用 <code>registerBeanDefinitions</code> 方法，执行自定义的注册逻辑。这个过程是 Spring 在启动时自动完成的，不需要手动调用。</p>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> annotationMetadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> beanDefinitionRegistry<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>AnnotationMetadata annotationMetadata</code>: 通过这个参数获取自定义注解 <code>@RpcScan</code> 的元数据，以便后续获取注解属性值。</p>
<h4 id="获取-RpcScan-注解的属性和值。"><a href="#获取-RpcScan-注解的属性和值。" class="headerlink" title="获取 @RpcScan 注解的属性和值。"></a>获取 @RpcScan 注解的属性和值。</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">AnnotationAttributes</span> rpcScanAnnotationAttributes <span class="token operator">=</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">.</span><span class="token function">fromMap</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">RpcScan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li><p><code>RpcScan.class.getName()</code> 获取了 <code>@RpcScan</code> 注解的全限定类名。(就是包名加上类名)</p>
</li>
<li><p><code>annotationMetadata.getAnnotationAttributes(...)</code> 返回一个 <code>Map&lt;String, Object&gt;</code>，其中包含了注解属性和对应的值。在这个情况下，map里就是<code>String[] basePackage();</code>和对应的值</p>
</li>
<li><p>通过 <code>AnnotationAttributes.fromMap(...)</code> 将 <code>Map&lt;String, Object&gt;</code> 转换为 <code>AnnotationAttributes</code> 对象，类似一个map,使得可以更方便地访问和操作注解的属性。</p>
</li>
</ol>
<h4 id="获取扫描包路径数组"><a href="#获取扫描包路径数组" class="headerlink" title="获取扫描包路径数组"></a>获取扫描包路径数组</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rpcScanBasePackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcScanAnnotationAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// get the value of the basePackage property</span>
            rpcScanBasePackages <span class="token operator">=</span> rpcScanAnnotationAttributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token constant">BASE_PACKAGE_ATTRIBUTE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//如果没有指定路径</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcScanBasePackages<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            rpcScanBasePackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">StandardAnnotationMetadata</span><span class="token punctuation">)</span> annotationMetadata<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIntrospectedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>解释一下第二个if:</p>
<p>如果没有指定路径，那么就通过反射，讲扫描包路径设置为当前被扫描的类所在的包</p>
<p><code>getIntrospectedClass()</code> 是 <code>StandardAnnotationMetadata</code> 类提供的方法之一，用于获取被 introspected（内省、审查）的类的 <code>Class</code> 对象。</p>
<h4 id="设置扫描器"><a href="#设置扫描器" class="headerlink" title="设置扫描器"></a>设置扫描器</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Scan the RpcService annotation</span>
<span class="token class-name">CustomScanner</span> rpcServiceScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomScanner</span><span class="token punctuation">(</span>beanDefinitionRegistry<span class="token punctuation">,</span> <span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Scan the Component annotation</span>
<span class="token class-name">CustomScanner</span> springBeanScanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomScanner</span><span class="token punctuation">(</span>beanDefinitionRegistry<span class="token punctuation">,</span> <span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>为什么不扫描RpcReference?</strong></p>
<p>RpcReference里面是@Target({ElementType.FIELD})</p>
<blockquote>
<p><code>RpcReference</code> 注解通常用于标记服务的引用，而不是服务的实现。在服务提供方，我们主要关注服务的实现，因此扫描 <code>RpcService</code> 注解可以找到被标记的服务实现类。而在服务消费方，我们主要关注服务的引用，即使用 <code>RpcReference</code> 注解标记的字段或方法参数。</p>
<p>在上下文中，通过扫描 <code>RpcService</code> 注解，框架能够找到服务的实现类并进行相应的处理。而对于 <code>RpcReference</code> 注解，框架可能会在服务消费方的代码中进行处理，以便在运行时动态生成代理对象，实现服务的远程调用。扫描 <code>RpcReference</code> 注解可能更适合在服务消费方的上下文中进行，以便找到需要生成代理的地方。</p>
<p>因此，框架选择性地扫描 <code>RpcService</code> 注解可能是为了满足服务提供方的需求，而在服务消费方的上下文中处理 <code>RpcReference</code> 注解。</p>
</blockquote>
<p>因为你的</p>
<h4 id="资源加载器设置到-CustomScanner-实例中"><a href="#资源加载器设置到-CustomScanner-实例中" class="headerlink" title="资源加载器设置到 CustomScanner 实例中"></a>资源加载器设置到 CustomScanner 实例中</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>resourceLoader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    rpcServiceScanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    springBeanScanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="扫描并注册"><a href="#扫描并注册" class="headerlink" title="扫描并注册"></a>扫描并注册</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> springBeanAmount <span class="token operator">=</span> springBeanScanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token constant">SPRING_BEAN_BASE_PACKAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"springBeanScanner扫描的数量 [&#123;&#125;]"</span><span class="token punctuation">,</span> springBeanAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> rpcServiceCount <span class="token operator">=</span> rpcServiceScanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>rpcScanBasePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"rpcServiceScanner扫描的数量 [&#123;&#125;]"</span><span class="token punctuation">,</span> rpcServiceCount<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>使用 <code>springBeanScanner</code> 扫描 Spring 组件（带有 <code>@Component</code> 注解的类）的数量，并记录日志。</li>
<li>使用 <code>rpcServiceScanner</code> 扫描 RPC 服务（带有 <code>@RpcService</code> 注解的类）的数量，并记录日志。</li>
</ol>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>CustomScanner</code> 和 <code>CustomScannerRegistrar</code> 的组合起到了扫描指定注解的作用，并将扫描到的类注册为 Spring Bean。</p>
<p><code>CustomScanner</code> ：主要功能就是调用父类进行扫描的实际操作</p>
<p><code>CustomScannerRegistrar</code>：主要功能就是 实现了 <code>ImportBeanDefinitionRegistrar</code> 接口，重写了<code>registerBeanDefinitions</code>函数，来定义要扫描哪些包，扫描有哪些注解的类</p>
<h2 id="SpringBeanPostProcessor"><a href="#SpringBeanPostProcessor" class="headerlink" title="SpringBeanPostProcessor"></a>SpringBeanPostProcessor</h2><p>傻逼guide说的原理：</p>
<blockquote>
<p>我们实现需要 BeanPostProcessor 接口并重写 postProcessBeforeInitialization()方法和 postProcessAfterInitialization() 方法。</p>
<p>Spring bean 在实例化之前会调用 postProcessBeforeInitialization()方法，在 Spring bean 实例化之后会调用  postProcessAfterInitialization() 方法。</p>
<p>被我们使用 RpcService和RpcReference 注解的类都算是 Spring Bean。</p>
<p>●我们可以在postProcessBeforeInitialization()方法中去判断类上是否有RpcService 注解。如果有的话，就取出 group 和 version 的值。然后，再调用 ServiceProvider 的 publishService() 方法发布服务即可！</p>
<p>●我们可以在 postProcessAfterInitialization() 方法中遍历类的属性上是否有  RpcReference 注解。如果有的话，我们就通过反射将这个属性赋值即可！</p>
</blockquote>
<h3 id="静态变量和构造函数"><a href="#静态变量和构造函数" class="headerlink" title="静态变量和构造函数"></a>静态变量和构造函数</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServiceProvider</span> serviceProvider<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RpcRequestTransport</span> rpcClient<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">SpringBeanPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serviceProvider <span class="token operator">=</span> <span class="token class-name">SingletonFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">ZkServiceProviderImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rpcClient <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">RpcRequestTransport</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token class-name">RpcRequestTransportEnum</span><span class="token punctuation">.</span><span class="token constant">NETTY</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>serviceProvider在provider包内，见对应文章</strong></p>
<p><code>serviceProvider</code>: 这是一个接口，用于提供服务注册的功能。通过 <code>SingletonFactory.getInstance(ZkServiceProviderImpl.class)</code> 来获取 <code>ZkServiceProviderImpl</code> 的单例实例，这是服务注册的一种具体实现。</p>
<p><code>rpcClient</code>: 这是一个接口，用于处理远程过程调用（RPC）。通过 <code>ExtensionLoader.getExtensionLoader(RpcRequestTransport.class).getExtension(RpcRequestTransportEnum.NETTY.getName())</code> 来获取 <code>RpcRequestTransport</code> 接口的具体实现，其中 <code>RpcRequestTransportEnum.NETTY.getName()</code> 表示获取 NETTY 实现，这是 RPC 请求的传输方式。</p>
<h3 id="postProcessBeforeInitialization"><a href="#postProcessBeforeInitialization" class="headerlink" title="postProcessBeforeInitialization"></a>postProcessBeforeInitialization</h3><p>在 Bean 初始化之前检查是否有 <code>@RpcService</code> 注解，如果有，则进行服务注册操作。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SneakyThrows</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[&#123;&#125;] is annotated with  [&#123;&#125;]"</span><span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// get RpcService annotation</span>
        <span class="token class-name">RpcService</span> rpcService <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RpcService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// build RpcServiceProperties</span>
        <span class="token class-name">RpcServiceConfig</span> rpcServiceConfig <span class="token operator">=</span> <span class="token class-name">RpcServiceConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>rpcService<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>rpcService<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceProvider<span class="token punctuation">.</span><span class="token function">publishService</span><span class="token punctuation">(</span>rpcServiceConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>@SneakyThrows</code>: Lombok 注解，用于在方法中抛出受检异常时不需要显式捕获。</p>
<p><code>@Override</code>: 表示该方法是对父类或接口中同名方法的重写。</p>
<p><code>postProcessBeforeInitialization</code>: 这是 BeanPostProcessor 接口定义的方法之一，在 Bean 初始化之前被调用。<code>Object bean</code>: 表示正在被初始化的 Bean 实例。</p>
<p><code>String beanName</code>: 表示正在被初始化的 Bean 的名称。</p>
<p><code>bean.getClass().isAnnotationPresent(RpcService.class)</code>: 检查当前 Bean 类是否被 <code>@RpcService</code> 注解标记。</p>
<p>如果被注解标记：</p>
<ul>
<li>通过 <code>bean.getClass().getAnnotation(RpcService.class)</code> 获取 <code>@RpcService</code> 注解的实例。</li>
</ul>
<ul>
<li>使用获取到的注解信息构建 <code>RpcServiceConfig</code> 对象。</li>
<li>调用 <code>serviceProvider.publishService(rpcServiceConfig)</code> 注册服务。这个里面最终是用Curator实现</li>
</ul>
<h3 id="postProcessAfterInitialization"><a href="#postProcessAfterInitialization" class="headerlink" title="postProcessAfterInitialization"></a>postProcessAfterInitialization</h3><p>在 Bean 初始化之后检查是否有 <code>@RpcReference</code> 注解，如果有，则创建相应的代理对象，并将其注入到对应的字段中。这是实现 RPC 客户端代理的关键逻辑。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> targetClass <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> declaredFields <span class="token operator">=</span> targetClass<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> declaredField <span class="token operator">:</span> declaredFields<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RpcReference</span> rpcReference <span class="token operator">=</span> declaredField<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RpcReference</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RpcServiceConfig</span> rpcServiceConfig <span class="token operator">=</span> <span class="token class-name">RpcServiceConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>rpcReference<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span>rpcReference<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RpcClientProxy</span> rpcClientProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcClientProxy</span><span class="token punctuation">(</span>rpcClient<span class="token punctuation">,</span> rpcServiceConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> clientProxy <span class="token operator">=</span> rpcClientProxy<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>declaredField<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            declaredField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                declaredField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> clientProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>Class&lt;?&gt; targetClass = bean.getClass()</code>: 获取当前 Bean 的类对象。</p>
<p><code>Field[] declaredFields = targetClass.getDeclaredFields()</code>: 获取当前 </p>
<p><code>for (Field declaredField : declaredFields)</code>: 遍历所有声明字段。</p>
<p><code>RpcReference rpcReference = declaredField.getAnnotation(RpcReference.class)</code>: 获取字段上的 <code>@RpcReference</code> 注解。</p>
<p><code>if (rpcReference != null)</code>: 如果字段上有 <code>@RpcReference</code> 注解，执行以下操作：</p>
<p>​	构建 <code>RpcServiceConfig</code> 对象，用于配置 RPC 服务的相关信息。</p>
<p>​	创建 <code>RpcClientProxy</code> 实例，用于生成动态代理对象。</p>
<p>​	通过 <code>rpcClientProxy.getProxy(declaredField.getType())</code> 获取代理对象。<strong>代理的部分见动态代理博客</strong></p>
<p><code>declaredField.setAccessible(true);</code>将字段设置为可访问</p>
<p><strong>为什么？</strong></p>
<p>绕过Java的访问修饰符，以便在运行时通过反射访问和修改字段的值。</p>
<p><code>declaredField.set(bean, clientProxy);</code></p>
<p>将创建的代理对象 <code>clientProxy</code> 设置为字段 <code>declaredField</code> 所在的对象 <code>bean</code> 的值，也就是把bean里面的代理类设置成我们新建的这个proxy类</p>
<p>如果类型不匹配就抛出异常</p>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p><code>SpringBeanPostProcessor</code> 类上使用了 <code>@Component</code> 注解，这意味着它会被 Spring 扫描并注册为一个 Spring Bean。由于它实现了 <code>BeanPostProcessor</code> 接口，Spring 在初始化每个 Bean 的过程中都会调用 <code>postProcessBeforeInitialization</code> 和 <code>postProcessAfterInitialization</code> 方法。</p>
<p>当一个类被标记为 <code>@Component</code> 时，Spring 会将其纳入到 IoC 容器的管理中，自动进行实例化并进行依赖注入。在这个过程中，如果该类同时实现了 <code>BeanPostProcessor</code> 接口，Spring 就会注意到它，并在适当的时机调用其 <code>postProcessBeforeInitialization</code> 和 <code>postProcessAfterInitialization</code> 方法。</p>
<p>因此，<code>@Component</code> 注解是触发 Spring 自动执行 <code>BeanPostProcessor</code> 方法的一种方式。</p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/rpc/">
                                    <span class="chip bg-color">rpc</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/12/01/%E8%87%AA%E5%AD%A6rpc%E4%B9%8B%E4%BC%98%E5%8C%96/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="自学rpc之优化">
                        
                        <span class="card-title">自学rpc之优化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-12-01
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/rpc/">
                        <span class="chip bg-color">rpc</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/11/27/%E8%87%AA%E5%AD%A6rpc%E4%B9%8B%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="自学和再看rpc之项目中的动态代理">
                        
                        <span class="card-title">自学和再看rpc之项目中的动态代理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-11-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/rpc/">
                        <span class="chip bg-color">rpc</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">G</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/GuSmallwhite" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>















    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</body>

</html>
